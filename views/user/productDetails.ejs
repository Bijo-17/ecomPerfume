
<%-include("../partials/user/header")%>
<head>
  
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  
  <style>
    .product-thumb {
      max-height: 100px;
      object-fit: cover;
      cursor: pointer;
    }
    .offer-box {
      background-color: #f8f9fa;
      border-left: 5px solid #198754;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    a {
      text-decoration: none;
      color: black;
    }

    .zoom-image {
  transition: transform 0.3s ease;
  cursor: zoom-in;
}

.zoom-image:hover {
  transform: scale(1.8);
  cursor: zoom-out;
  z-index: 10;
}

.star {
  color: #ccc;
  font-size: 1.2rem;
}
.star.filled {
  color: gold;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}


  </style>
</head>
<body>
 
  <div class="container my-5">
  <div class="row g-5 flex-column flex-md-row">
    <!-- Left (Mobile: Bottom) — Image Gallery -->
    <div class="col-md-6">
      <div class="card shadow-sm p-3 rounded">
        <!-- Main Image -->
        <div class="text-center mb-3">
          <img
            src="<%= product.image[0] %>"      
            id="mainImage"
            class="img-fluid rounded zoom-image"
            style="max-height: 400px; object-fit: contain; width: 100%;"
            alt="Main Product Image"
          />
        </div>

        <!-- Thumbnails -->
        <div class="d-flex flex-wrap justify-content-center gap-2">
          <% for(let i = 0; i < product.image.length; i++) { %>
            <img
              src="<%= product.image[i] %>"
              class="img-thumbnail"
              style="width: 70px; height: 70px; object-fit: cover; cursor: pointer;"
              onclick="document.getElementById('mainImage').src=this.src"
              alt="Thumbnail <%= i + 1 %>"
            />
          <% } %>
        </div>
      </div>
    </div>

    <!-- Right (Mobile: Top) — Product Details -->
    <div class="col-md-6">
      <h2 class="fw-bold mb-2"><%=product.product_name%></h2>
      <p class="text-muted"><%= product.brand_id.name %></p>

      <div class="rating">
  <% const filled = Math.floor(product.averageRating || 0); %>
  <% for (let i = 0; i < 5; i++) { %>
    <% if (i < filled) { %>
      <span class="star filled">★</span>
    <% } else { %>
      <span class="star">☆</span>
    <% } %>
  <% } %>
  <span class="rating-count">(<%= ratings.length %>)</span>
</div> <br>






      <h4 class="text-success">
        ₹<%= product.final_price %>
        <small class="text-muted text-decoration-line-through ms-2">₹<%= product.regular_price %></small>
      </h4>

      <!-- Volume Variants -->
      <div class="mb-3">
        <label class="form-label fw-bold">Select Volume (ML):</label><br>
        <div class="btn-group" role="group">
          <% product.volume.forEach((vol, i) => { %>
            <input type="radio" class="btn-check" name="volume" id="v<%= i %>" <%= i === 0 ? 'checked' : '' %>>
            <label class="btn btn-outline-primary" for="v<%= i %>"><%= vol %></label>
          <% }) %>
        </div>
      </div>

      <!-- Quantity -->
      <div class="mb-3">
        <label class="form-label fw-bold">Quantity:</label>
        <input type="number" class="form-control w-50 w-md-25" value="1" min="1" />
      </div>

      <!-- Coupon -->
      <div class="mb-3">
        <label class="form-label fw-bold">Apply Coupon:</label>
        <div class="input-group">
          <input type="text" class="form-control" placeholder="Enter coupon code" />
          <button class="btn btn-outline-secondary" type="button">Apply</button>
        </div>
      </div>

      <!-- Offers -->
      <div class="offer-box mb-4">
        <strong>Limited Time Offer:</strong>
        <ul class="mb-0">
          <!-- <li>Buy 1 Get 1 Free</li> -->
          <li>Free shipping on orders above ₹500</li>
        </ul>
      </div>

      <!-- Buttons -->

       <% if(product_status === 'Out of stock' || product.stock === 0 ) { %> 
        <div class="d-grid gap-2 d-md-flex">        
           <h4>Out of stock</h4>
        </div>
        <% } else if(product.isBlocked) {%>
         <div class="d-grid gap-2 d-md-flex"> 
          <h4>Unavailable</h4>
         </div>
          <% } else {%>
      <div class="d-grid gap-2 d-md-flex">
        <button class="btn btn-warning me-md-2 w-100 w-md-auto" id="addToCart-btn">Add to Cart</button>
        <!-- <button class="btn btn-success w-100 w-md-auto">Buy Now</button> -->
      </div>
         <% } %>
    </div>
  </div>
</div>


  <!-- Tabs -->
  <div class="mt-5 container">
    <ul class="nav nav-tabs" id="productTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link active"
          id="desc-tab"
          data-bs-toggle="tab"
          data-bs-target="#desc"
          type="button"
          role="tab"
        >
          Description
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="details-tab"
          data-bs-toggle="tab"
          data-bs-target="#details"
          type="button"
          role="tab"
        >
          Product Details
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="reviews-tab"
          data-bs-toggle="tab"
          data-bs-target="#reviews"
          type="button"
          role="tab"
        >
          Reviews
        </button>
      </li>
    </ul>
    <div class="tab-content border border-top-0 p-3" id="productTabContent">
      <div class="tab-pane fade show active" id="desc" role="tabpanel">
        <p><%=product.description%></p>
      </div>
      <div class="tab-pane fade" id="details" role="tabpanel">
        <ul>
          <li>Type: Eau de Parfum</li>
          <li>Volume: 30ml / 50ml / 100ml</li>
          <li>Fragrance Notes: Citrus, Musk, Vanilla</li>
          <li>Long-lasting formula</li>
        </ul>
      </div>
      <div class="tab-pane fade" id="reviews" role="tabpanel">
        <p><strong>John:</strong> “Amazing fragrance! Worth every rupee.”</p>
        <p><strong>Aisha:</strong> “Smells divine and lasts long.”</p>

        <!-- Display reviews -->
    <% ratings.forEach(r => { %>
       <div class="border-bottom mt-3">
      <strong><%= r.user_id.name %></strong>: <%= r.review %>
       <div class="text-warning">
       <% for (let i = 0; i < r.rating; i++) { %>★<% } %>
      </div>
      </div>
   <% }) %>  
      </div>
    </div>
  </div>


 <div class="container"> 
  <form action="/rateProduct/<%= product._id %>" method="POST">
  <label for="rating">Rate this product:</label>
  <select name="rating" required>
    <% for(let i = 1; i <= 5; i++) { %>
      <option value="<%= i %>"><%= i %> Star</option>
    <% } %>
  </select>
  
 
    <textarea name="review" placeholder="Write a review (optional)" class="form-control my-2"></textarea>
    <button type="submit" class="btn btn-sm btn-primary">Submit</button>
</form>
</div>

<!-- realted products -->

<div class="container my-5">
  <h4 class="mb-4">Related Products</h4>
  <div class="row g-4">
    <% relatedProducts.forEach(rp => { %>
      <div class="col-md-3 col-6">
        <div class="card h-100 shadow-sm">
          <img src="<%= rp.image[0] %>" class="card-img-top img-fluid" style="height: 200px; object-fit: cover;" alt="<%= rp.product_name %>">
          <div class="card-body text-center">
              <h6 class="card-subtitle text-muted mb-1"><%= rp.brand_id?.name %></h6>
            <h6 class="card-title mb-1"><%= rp.product_name %></h6>

            <div class="mb-2">
                <% for (let i = 0; i < 5; i++) { %>
                  <% if (i < Math.floor(rp.averageRating)) { %>
                    <span class="text-warning">★</span>
                  <% } else { %>
                    <span class="text-secondary">☆</span>
                  <% } %>
                <% } %>
                <small class="text-muted">(<%= rp.ratingCount %>)</small>
              </div>
            <p class="text-success fw-bold mb-1">₹<%= rp.final_price %></p>
            <p class="text-muted text-decoration-line-through mb-2">₹<%= rp.regular_price %></p>
            <a href="/productDetails/<%= rp._id %>" class="btn btn-outline-primary btn-sm">View</a>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
</div>


<%-include("../partials/user/footer")%>

<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  const mainImage = document.getElementById('mainImage');
  let zoomed = false;

  mainImage.addEventListener('click', function () {
    if (window.innerWidth < 768) { // only on mobile
      zoomed = !zoomed;
      mainImage.style.transform = zoomed ? 'scale(2)' : 'scale(1)';
      mainImage.style.cursor = zoomed ? 'zoom-out' : 'zoom-in';
    }
  });

 document.getElementById('addToCart-btn').addEventListener('click',async ()=>{

  console.log("enterd")
   
   const response = await fetch("/addToCart/<%= product._id%>",{
         
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
   })

 const data = await response.json();


      if (data.success) {
        Swal.fire({        
         icon: "success",
          title: "Item added to Cart ",
          showConfirmButton: false,
            timer: 1200,
             willClose: () => {
                window.location.reload();
             }

        })
    
      }else {
        Swal.fire({
           icon: "error",
            title: data.message || "something went wrong",
            showConfirmButton:false, 
            timer:1200, 
             willClose: () => {
              window.location.reload();
             }
        })
      }

 })




</script>

</body>

