
<h1>Manage Addresses</h1>

<div class="address-container">
    <button id="addAddressBtn" class="btn-add-address" onclick="openEditBox('addressAddForm')">
        <i class="fas fa-plus"></i> Add New Address
    </button>
    
    <div id="addressAddForm" class="address-form" style="display:none;">
        <h2>Add New Address</h2>
        <form id="newAddressForm" method="post" action="/address/addAddress">
            <div class="form-row">
                
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName" name="fullName" value="<%= user.firstName %> <%= user.lastName %>"  >
                    <div class="error-message" id="name-error"> </div>
                </div>
                               
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="mobileNumber">Mobile Number</label>
                    <input type="text" id="mobileNumber" name="mobileNumber" value="<%= user.mobile %>" >
                     <div class="error-message" id="phone-error"> </div>
                </div>
                <div class="form-group">
                    <label for="pinCode">Pin Code</label>
                    <input type="text" id="pinCode" name="pinCode" value="<%= user.pincode %>" >
                     <div class="error-message" id="pin-error"> </div>
                </div>
                   <div class="form-group">
                    <label for="mobileNumber">Alternate Mobile Number (optional) </label>
                    <input type="text" id="altMobileNumber" name="alt_phone_number" value="<%= user.alt_phone_number%>">
                     <div class="error-message" id="altPhoneNumber-error"> </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group full-width">
                    <label for="address_name">Address (House No, Building, Street, Area)</label>
                    <textarea id="addressName" name="address_name" rows="3" ><%= user.address?.address_name %></textarea>
                     <div class="error-message" id="address-error"> </div>
                </div>
            </div>

             <div class="form-row">
                <div class="form-group full-width">
                    <label for="landmark">Landmark (optional) </label>
                    <input type="text" id="landmark" name="landmark"><%= user.address?.landmark %>
                     <div class="error-message" id="landmark-error"> </div>
                </div>
            </div>
            
            
            <div class="form-row">
                <div class="form-group">
                    <label for="locality">Locality/Town</label>
                    <input type="text" id="locality" name="locality" value="<%= user.city %>" >
                     <div class="error-message" id="locality-error"></div>
                </div>
                <div class="form-group">
                    <label for="cityDistrict">City/District</label>
                    <input type="text" id="cityDistrict" name="cityDistrict" value="<%= user.city %>" >
                     <div class="error-message" id="city-error"></div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="stateRegion">State</label>
                    <select id="stateRegion" name="stateRegion" >
                        <option value="" selected> </option>
                        <option value="Kerala">Kerala</option>
                        <option value="Tamil Nadu">Tamil Nadu</option>
                        <option value="Karnataka">Karnataka</option>
                       
                      
                    </select>
                     <div class="error-message" id="state-error"> </div>
                </div>
                <div class="form-group">
                    <label for="address_type">Address Type</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="address_type" value="home" checked>
                            <span>Home</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="address_type" value="work">
                            <span>Work</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="makeDefault">
                        <span>Make this my default address</span>
                    </label>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" id="cancelAddressBtn" onclick="closeEditBox('addressAddForm')">CANCEL</button>
                <button type="submit" id="submitForm">SAVE</button>
            </div>
        </form>
    </div>

      <!-- address listing -->
    
    <div class="address-list" >
        <% if (addresses && addresses.length > 0) { %>
            <% addresses.forEach((address, index) => { %>
                <div class="address-card <%= address.isDefault ? 'default' : '' %>">
                    <% if (address.isDefault) { %>
                        <div class="default-badge">Default</div>
                    <% } %>
                    <div class="address-header">
                        <h4><%= address.name %></h4 >
                        <span class="address-type <%= address.address_type %>"><%= address.address_type %></span>
                    </div>
                    <div class="address-content">
                     
                        <p><%= address.address_name %></p>
                        <p><%= address.locality %>, <%= address.city %></p>
                        <p><%= address.state %> - <%= address.pin_code %></p>
                        <p>Mobile: <%= address.phone_number %></p>
                    </div>
                    <div class="address-actions">
                        <button class="btn-edit" data-id="<%= index %>" onclick="editAddressBox('addressEditForm-<%= address._id %>')">EDIT</button> 
                        <form action="/address/<%= address._id %>?_method=DELETE" method="POST">
                            <button class=btn btn-danger type="button" onclick="deleteAddress('<%= address._id %>')">DELETE</button>
                         </form>

                       <form action="/address/setDefault/<%= address._id %>" method="POST" >
                        <% if (!address.isDefault) {   %>
                       
                            <button class="btn-default" data-id="<%= index %>">SET AS DEFAULT</button>
                        <% } %>
                       </form>
                    </div>
                </div>
            <% }); %>
        <% } else { %>
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <h2>No Saved Addresses</h2>
                <p>You don't have any saved addresses yet. Add a new address to get started.</p>
            </div>
        <% } %>
    </div>
</div>


  <!-- edit address box -->

  <% addresses.forEach(address=> { %>

 <div id="addressEditForm-<%= address._id %>" class="address-form"   style="display: none; position: fixed; top: 1; right:0;
      z-index: 9999; overflow-y: auto; font-size:medium;  height: 100%;
    align-items: center; justify-content: center;"  >
        <h3>Edit Address</h3>
        <form id="editAddressForm" method="post" action="/address/editAddress">
             <input type="hidden" name="addressId" value="<%= address._id %>">
            <div class="form-row">
                
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text"  name="name" value="<%= address.name %> " required>
                </div>
                <div class="form-group">
                 
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="mobileNumber">Mobile Number</label>
                    <input type="text"  name="phone_number" value="<%= address.phone_number %>" required>
                </div>
                <div class="form-group">
                    <label for="pinCode">Pin Code</label>
                    <input type="text"  name="pin_code" value="<%= address.pin_code %>" required>
                </div>
                   <div class="form-group">
                    <label for="mobileNumber">Alternate Mobile Number (optional) </label>
                    <input type="text"  name="alt_phone_number" value="<%= address.alt_phone_number%>">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group full-width">
                    <label for="address_name">Address (House No, Building, Street, Area)</label>
                    <textarea  name="address_name" rows="3" required><%= address.address_name %></textarea>
                </div>
            </div>

             <div class="form-row">
                <div class="form-group full-width">
                    <label for="landmark">Landmark (optional) </label>
                    <input type="text"  name="landmark" value="<%= address?.landmark %>"  >
                </div>
            </div>
            
            
            <div class="form-row">
                <div class="form-group">
                    <label for="locality">Locality/Town</label>
                    <input type="text"  name="locality" value="<%= address.locality %>" required>
                </div>
                <div class="form-group">
                    <label for="cityDistrict">City/District</label>
                    <input type="text"  name="city" value="<%= address.city %>" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="stateRegion">State</label>
                    <select  name="state" required>
                        <option value="<%= user.state %>" selected><%= address.state %></option>
                        <option value="Tamil Nadu">Tamil Nadu</option>
                        <option value="Karnataka">Karnataka</option>
                        <option value="Kerala">Kerala</option>
                        <!-- Add more states as needed -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="address_type">Address Type</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="address_type" value="home" <%=address.address_type === 'home'? 'checked' : ''%> >
                            <span>Home</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="address_type" value="work" <%=address.address_type === 'work'? 'checked' : ''%> >
                            <span>Work</span>
                        </label>
                    </div>
                </div>
            </div>
            
            
            <div class="form-actions">
                <button type="button" id="cancelAddressBtn" onclick="closeEditBox('addressEditForm-<%= address._id %>')">CANCEL</button>
                <button type="submit">SAVE</button>
            </div>
        </form>
    </div>
   <%})%>

<script>

function openEditBox(value){
    document.getElementById(value).style.display = 'block' ;  
}

function closeEditBox(value){
     document.getElementById(value).style.display = 'none' ;
}

function editAddressBox(value){

    document.getElementById(value).style.display = 'block' ;
      
}

document.addEventListener('DOMContentLoaded', function(){
       document.getElementById('newAddressForm').addEventListener('submit', (e)=>{
           e.preventDefault();

           clearErrorMessage();


           const name = document.getElementById('fullName').value.trim();
           const mobileNumber = document.getElementById('mobileNumber').value.trim();
           const pinCode = document.getElementById('pinCode').value.trim();
           const altPhoneNumber = document.getElementById('altMobileNumber').value.trim();
           const address = document.getElementById('addressName').value.trim();
           const landmark = document.getElementById('landmark').value.trim();
           const locality = document.getElementById('locality').value.trim();
           const city = document.getElementById('cityDistrict').value.trim();
           const state = document.getElementById('stateRegion').value;

           let isValid = true;
            const namePattern = /^[A-Za-z\s]+$/;

           if(!name){
              displayErrorMessage('name-error',"Please enter a name");
              isValid = false
           } else if(name.length < 3){
              displayErrorMessage('name-error',"Name should be atleast three letters");
               isValid = false
           } else if(!namePattern.test(name)){
               displayErrorMessage('name-error' , 'Name can only contain alphabets');
                isValid=false;
           } 

            const numberPattern = /^[0-9]+$/;
            const sameDigit = /^(\d)\1{9}$/;

           if(!mobileNumber){
              displayErrorMessage('phone-error',"Please enter your phone number");
                isValid = false;
           } else if(!numberPattern.test(mobileNumber)){
                displayErrorMessage('phone-error', 'Phone number can only contain numbers');
                isValid = false;
           } else if( sameDigit.test(mobileNumber)){
                 displayErrorMessage('phone-error' , 'Enter a valid phone number');
                 isValid = false;
           } else if(mobileNumber.length !== 10){
                displayErrorMessage('phone-error' , 'Please enter 10 digit valid number');
                isValid = false;
           }

           if(!pinCode){
               displayErrorMessage('pin-error', 'Please enter your pin code');
                isValid = false;
           } else if(!numberPattern.test(pinCode)){ 
                displayErrorMessage('pin-error', 'Pin can only contain numbers');
                 isValid = false;
           } else if(pinCode.length != 7){
                displayErrorMessage('pin-error' , 'Please enter a valid pin');
                 isValid = false;
           } 

           if(altPhoneNumber && !numberPattern.test(altPhoneNumber) ){
                   displayErrorMessage('altPhoneNumber-error' , 'Phone number can only contain numbers')
                   isValid = false;
            } else if( altPhoneNumber && altPhoneNumber.length !== 10){
               displayErrorMessage('altPhoneNumber-error', "Please enter a 10 digit valid number" );
                isValid = false;
           }

           if(!address){
              displayErrorMessage('address-error', 'Please enter your address');
               isValid = false;
           }else if(address.length < 5){
              displayErrorMessage('address-error' , 'Address is insufficient for delivery')
               isValid = false;
           }
        
           if(!locality){
               displayErrorMessage('locality-error' , 'Please enter your loaclity');
                isValid = false;
           }else if(locality.length < 3){
               displayErrorMessage('locality-error' , 'Please enter a valid Place');
                isValid = false;
           }

           if(!city){
               displayErrorMessage('city-error' , 'Please enter your city')
                isValid = false;
           } else if(city.length < 3){
                 displayErrorMessage('city-error' , 'Please enter a valid city')
                  isValid = false;
           }

           if(!state){
               displayErrorMessage('state-error' , 'Please select the state');
                isValid = false;
           }

           if(isValid){
             e.target.submit();
           }
         
       })

       function displayErrorMessage(value, message){
     
           document.getElementById(value).innerText = message;
       }

      function clearErrorMessage(){
   
             document.querySelectorAll('.error-message').forEach(msg=>{
                 msg.innerText = '';
        
             })
       }
})


 async function deleteAddress(addressId) {
          
         const result = await Swal.fire({
                  title: "Are you sure?",
                   text: "You won't be able to revert this!",
                   icon: "warning",
                   showCancelButton: true,
                   confirmButtonColor: "#d33",
                   cancelButtonColor: "#3085d6",
                   confirmButtonText: "Yes, delete it!",
              })
            
                     if(result.isConfirmed){

                        const response = await fetch( action=`/address/${addressId}` , { 
                           method : 'DELETE' 

                        });

                        if(response.ok){ 
                          await Swal.fire("Deleted!", "Address has been deleted.", "success");
                         window.location.reload();
                        } else {
                          await Swal.fire("Error!", "Failed to delete category.", "error");
                        }

                     }          
      }

</script>

