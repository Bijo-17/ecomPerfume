
<%- include("../../views/partials/admin/header") %>
<head> 
<style>
 
 .badge-sealed {
  display: inline-block;
  background: repeating-linear-gradient(
    -45deg,
    #f44336,
    #f44336 10px,
    #d32f2f 10px,
    #d32f2f 20px
  );
  color: #fff;
  padding: 5px 12px;
  border-radius: 12px;
  font-weight: bold;
  font-size: 0.875rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  border: 2px solid #c62828;
  text-shadow: 1px 1px #00000030;
  cursor: not-allowed;
}

.pagination-container {
    text-align: center;
    width: 100%;
    overflow-x: auto;
    white-space: nowrap;
    padding: 10px 0;
  }

  .pagination {
    display: flex;
    flex-wrap: nowrap;
    justify-content: center;
    gap: 4px;
  }

  .pagination li {
    display: inline-block;
  }

  .pagination a,
  .pagination .page-link {
    display: inline-block;
    padding: 5px 12px;
    margin: 0;
    border: 1px solid #ddd;
    text-decoration: none;
    color: #333;
  }

  .pagination .active .page-link {
    background-color: #088178;
    color: white;
    border-color:  #088170;
  }

  .pagination a:hover {
    background-color: #f5f5f5;
  }



</style>

</head>


<section class="content-main">
    <div class="content-header">
        <h2 class="content-title">Order Management</h2>
        <div>
            <form id="searchForm" class="d-flex" style="gap: 10px;">
                <input type="text" name="search" placeholder="Search by Order ID/User" class="form-control" value="<%= searchQuery || '' %>">
                <select name="status" class="form-select">
                    <option value="">All Status</option>
                    <option value="pending" <%=status ==='pending' ? 'selected': '' %>>Pending</option>
                    <option value="shipped" <%=status ==='shipped' ? 'selected': '' %>>Shipped</option>
                    <option value="out-for-delivery" <%=status ==='out-for-delivery' ? 'selected': '' %>>Out for Delivery</option>
                    <option value="delivered" <%=status ==='delivered' ? 'selected': '' %>>Delivered</option>
                    <option value="cancelled"<%=status ==='cancelled' ? 'selected': '' %>>Cancelled</option>
                     <!-- <option value="failed"<%=status ==='failed' ? 'selected': '' %>>Failed</option> -->
                </select>
                <button type="submit" class="btn btn-primary">Search</button>
                <a href="/admin/orderList" class="btn btn-light">Clear</a>
            </form>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <table class="table table-hover table-bordered">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Order ID</th>
                        <th>Date</th>
                        <th>User</th>
                        <th>Product</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                 
           <tbody>
                  <% orders.forEach((order, index) => { %>
                  <% const rowSpan = order.order_items.length; %>
                   <% const bgColor = index % 2 === 0 ? 'table-light' : 'table-secondary'; %>

                    <% order.order_items.forEach((item, itemIndex) => { %>
              <tr class="<%= bgColor %>">
                   <% if (itemIndex === 0) { %>
                      <td rowspan="<%= rowSpan %>"><%= index + 1 %></td>
                      <td rowspan="<%= rowSpan %>"><%= order.order_id %></td>
                      <td rowspan="<%= rowSpan %>"><%= new Date(order.createdAt).toLocaleDateString() %></td>
                     <td rowspan="<%= rowSpan %>"><%= order?.user_id?.name %> (<%= order?.user_id?.email %>)</td>
                  <% } %>
                  <td><%= item?.product_id?.product_name%> x (<%= item?.quantity%>) </td>
                  <td>
               <% if(item.order_status === 'returned' || item.order_status === 'failed' ){ %> 

                  <span class="badge badge-sealed" title="No further actions allowed">
                      <i class="fas fa-lock"></i> <%= item.order_status.toUpperCase() %>
                 </span>

                <% } else {  %>

          <form method="POST" action="/admin/updateOrderStatus/<%= order._id %>/<%= item.product_id._id %>?page=<%=currentPage%>">
            <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
              <option value="pending" <%= item.order_status === 'pending' ? 'selected' : '' %>>Pending</option>
              <option value="shipped" <%= item.order_status === 'shipped' ? 'selected' : '' %>>Shipped</option>
              <option value="out_for_delivery" <%= item.order_status === 'out_for_delivery' ? 'selected' : '' %>>Out for Delivery</option>
              <option value="delivered" <%= item.order_status === 'delivered' ? 'selected' : '' %>>Delivered</option>
              <option value="cancelled" <%= item.order_status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
            </select>
          </form>
          <% } %>
        </td>

        <td>
               <% if (item.return_request?.status === 'requested') { %>
            <span class="btn btn-sm btn-warning" >Return Requested </span>
          <% } %>
          <a href="/admin/orderDetails/<%= order._id %>/<%= item._id%>" class="btn btn-sm btn-info">View</a>
       
        </td>
      </tr>
    <% }) %>
  <% }) %>
</tbody>



            </table>

  
            <nav aria-label="Page navigation">
              <ul class="pagination justify-content-center">
         
               <% if (currentPage > 1) { %>
                  <% if( currentPage > 2) { %> 
                    <li class="page-item">
                      <a class="page-link" href="?page=1<%= searchQuery ? '&search=' + searchQuery : '' %>">First</a>
                    </li>
                  <% } %>
                  <li class="page-item">
                      <a class="page-link" href="?page=<%= currentPage - 1 %><%= searchQuery ? '&search=' + searchQuery : '' %>">Prev</a>
                  </li>
               <% } %>

                   <% 
                      let startPage = Math.max(1, currentPage - 1);  
                      let endPage = Math.min(totalPages, startPage + 3);  

                      if (endPage - startPage < 3) {
                         startPage = Math.max(1, endPage - 3);  
                       }
                    %>

                   <% for (let i = startPage; i <= endPage; i++) { %>
                      <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                        <a class="page-link" href="?page=<%= i %><%= searchQuery ? '&search=' + searchQuery : '' %>"><%= i %></a>
                      </li>
                   <% } %>

                    <% if (endPage < totalPages) { %>
                        <li class="page-item disabled">
                           <span class="page-link">...</span>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page=<%= totalPages %><%= searchQuery ? '&search=' + searchQuery : '' %>"><%= totalPages %></a>
                        </li>
                     <% } %>
                    
                     <% if (totalPages > currentPage) { %> 
                            
                              <li class="page-item">
                                <a class="page-link" href="?page=<%= currentPage + 1 %><%= searchQuery ? '&search=' + searchQuery : '' %>">Next</a>
                              </li>
                            
                      
                     <% } %>

              </ul>
            </nav>



        </div>
    </div>
</section>

<%- include("../../views/partials/admin/footer") %>







